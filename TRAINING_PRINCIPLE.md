# OCR 模型訓練原理詳解

## 🧠 模型架構：CRNN (CNN + RNN + CTC)

### 1. CNN 特徵提取層
```
輸入圖片 (32x128) 
    ↓
Conv2D + BatchNorm + ReLU + MaxPool (32 filters)
    ↓
Conv2D + BatchNorm + ReLU + MaxPool (64 filters)
    ↓
Conv2D + BatchNorm + ReLU (128 filters)
    ↓
Conv2D + BatchNorm + ReLU + MaxPool (256 filters)
    ↓
特徵圖 (256x2x32)
```

**作用**：
- 提取圖片的視覺特徵
- 逐層抽象：邊緣 → 筆劃 → 字元部件 → 字元特徵
- BatchNorm：穩定訓練，加速收斂
- MaxPool：降低維度，擴大感受野

### 2. RNN 序列建模層（雙向 LSTM）
```
CNN 特徵序列
    ↓
BiLSTM (128 hidden units, 2 layers)
    ↓
序列特徵 (時間步 x 256)
```

**作用**：
- 處理序列依賴關係
- 雙向：同時考慮前後文
- LSTM：解決長距離依賴問題
- 學習字元間的關聯性

### 3. CTC 損失函數
```
預測序列: [H, E, L, L, L, O]
真實標籤: [H, E, L, O]
CTC 對齊: 自動處理重複和空白
```

**原理**：
- **無需字元級對齊**：不需要標註每個字元的位置
- **處理重複**：HE-LL-O → HELLO
- **插入空白**：使用 blank token 分隔字元
- **動態規劃**：計算所有可能路徑的機率和

## 📊 訓練過程

### 1. 資料預處理
```python
圖片 → 灰階 → 二值化 → 縮放(32x128) → 正規化(0-1)
標籤 → 大寫 → 字元編碼 → 張量
```

### 2. 資料增強（解決過擬合）
- **旋轉**: ±5度（模擬拍攝角度）
- **縮放**: 0.9-1.1x（模擬距離變化）
- **模糊**: 高斯模糊（模擬失焦）
- **噪點**: 隨機噪聲（模擬圖片品質）
- **干擾線**: 模擬驗證碼特徵

### 3. 前向傳播
```
1. 圖片通過 CNN 提取特徵
2. 特徵序列通過 BiLSTM 建模
3. 全連接層輸出字元機率
4. CTC 解碼得到預測文字
```

### 4. 反向傳播
```
1. CTC Loss 計算預測與真實的差異
2. 梯度反向傳播更新權重
3. Adam 優化器自適應調整學習率
4. L2 正則化防止過擬合
```

## 🎯 關鍵技術解決的問題

### 問題 1：標籤對齊
**傳統 OCR**：需要標註每個字元的位置
**CRNN+CTC**：只需整張圖片的文字標籤

### 問題 2：序列長度不固定
**解決**：CTC 自動處理不同長度的輸入輸出

### 問題 3：過擬合（你遇到的問題）
**原因**：
- 訓練資料記憶化
- 模型過於複雜
- 缺乏正則化

**解決**：
- 強化資料增強
- Dropout (0.5)
- L2 權重衰減
- 早停機制

### 問題 4：推理速度
**優化**：
- 輕量化 CNN（減少層數）
- 減小 LSTM 隱藏層（128 vs 256）
- 批次推理

## 📈 訓練策略

### 1. 學習率調度
```python
初始: 0.0005
策略: ReduceLROnPlateau
下降: 驗證準確率不提升時減半
```

### 2. 早停機制
```python
耐心: 20 epochs
監控: 驗證準確率
保存: 最佳模型
```

### 3. 梯度裁剪
```python
max_norm = 5.0
防止梯度爆炸
```

## 🔬 為什麼達到 99.38% 準確率？

1. **資料品質**：5387 個標註樣本
2. **資料增強**：大幅提升泛化能力
3. **架構合適**：CRNN 適合序列識別
4. **正則化充分**：Dropout + L2
5. **訓練策略**：學習率調度 + 早停

## 💡 核心洞察

1. **CTC 的威力**：自動學習對齊，無需精確標註
2. **CNN+RNN 組合**：視覺特徵 + 序列關係
3. **資料增強關鍵**：從 6% → 99% 的關鍵
4. **簡單模型更好**：輕量化反而效果更好

## 🚀 推理過程

```python
輸入圖片
    ↓ 預處理（二值化、縮放）
    ↓ CNN 特徵提取（~2ms）
    ↓ BiLSTM 序列建模（~3ms）
    ↓ CTC 解碼（~1ms）
輸出文字（總計 ~7ms）
```

這就是從圖片到文字的完整過程！